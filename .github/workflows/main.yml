name: Ghostlang CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  grammar:
    name: Tree-sitter Grammar Tests
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: tree-sitter-ghostlang/package.json

    - name: Install tree-sitter dependencies
      working-directory: tree-sitter-ghostlang
      run: npm install

    - name: Generate grammar
      working-directory: tree-sitter-ghostlang
      run: npx tree-sitter generate

    - name: Run grammar tests
      working-directory: tree-sitter-ghostlang
      run: npx tree-sitter test

    - name: Validate query files
      working-directory: tree-sitter-ghostlang
      run: |
        echo "Validating query files..."
        test -f queries/highlights.scm
        test -f queries/locals.scm
        test -f queries/injections.scm
        test -f queries/textobjects.scm

  language:
    name: Ghostlang Runtime
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Verify Zig installation
      run: |
        zig version
        echo "Zig path: $(which zig)"

    - name: Build Ghostlang runtime
      run: |
        zig build
        echo "Build completed successfully"

    - name: Run Zig tests
      run: |
        zig build test
        echo "All tests passed"

  integration:
    name: Integration Test
    runs-on: self-hosted
    needs: [grammar, language]

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: tree-sitter-ghostlang/package.json

    - name: Build complete system
      run: |
        cd tree-sitter-ghostlang
        npm install
        npx tree-sitter generate
        cd ..
        zig build
        zig build test
        echo "Integration test passed"